<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#f5efe0">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="SLF">
<meta name="mobile-web-app-capable" content="yes">
<script>
  function generateIcon(size) {
    const c = document.createElement('canvas');
    c.width = c.height = size;
    const x = c.getContext('2d');
    x.fillStyle = '#f5efe0';
    x.beginPath(); x.roundRect(0,0,size,size,size*.22); x.fill();
    const cx = size/2;
    const g = x.createRadialGradient(cx,cx*.85,0,cx,cx,size*.38);
    g.addColorStop(0,'#e8507a'); g.addColorStop(1,'#c0334d');
    x.fillStyle = g;
    x.beginPath(); x.arc(cx,cx,size*.38,0,Math.PI*2); x.fill();
    x.fillStyle = '#fdf6e8';
    x.font = `bold ${size*.38}px Georgia,serif`;
    x.textAlign = 'center'; x.textBaseline = 'middle';
    x.fillText('S', cx, cx + size*.02);
    return c.toDataURL('image/png');
  }
  const mf = {
    name:"Stadt Land Fluss", short_name:"SLF", start_url:".", display:"standalone",
    background_color:"#f5efe0", theme_color:"#c0334d", orientation:"portrait",
    icons:[
      {src:generateIcon(192), sizes:"192x192", type:"image/png", purpose:"any maskable"},
      {src:generateIcon(512), sizes:"512x512", type:"image/png", purpose:"any maskable"}
    ]
  };
  const ml = document.createElement('link');
  ml.rel = 'manifest';
  ml.href = URL.createObjectURL(new Blob([JSON.stringify(mf)],{type:'application/json'}));
  document.currentScript.after(ml);
</script>
<script>
  window.addEventListener('DOMContentLoaded', () => {
    const al = document.createElement('link');
    al.rel = 'apple-touch-icon'; al.href = generateIcon(180);
    document.head.appendChild(al);
    const fl = document.createElement('link');
    fl.rel = 'icon'; fl.href = generateIcon(64); fl.type = 'image/png';
    document.head.appendChild(fl);
  });
</script>
<title>Stadt Land Fluss</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Mono:wght@300;500&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg: #f5efe0;
  --bg2: #fdf6e8;
  --ink: #3a2e1e;
  --pink: #c0334d;
  --green: #7dc45a;
  --lilac: #c46fa0;
  --yellow: #f0b93a;
  --sky: #e8507a;
  --peach: #d94f72;
}

body {
  background: var(--bg);
  color: var(--ink);
  font-family: 'DM Mono', monospace;
  min-height: 100vh;
  min-height: 100dvh;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  user-select: none;
  position: relative;
  -webkit-tap-highlight-color: transparent;
  touch-action: manipulation;
}

/* Background blobs */
.blob {
  position: fixed;
  border-radius: 50%;
  filter: blur(70px);
  opacity: .22;
  pointer-events: none;
  z-index: 0;
}
.blob-1 { width:380px; height:380px; background:var(--pink);   top:-80px;    left:-80px; }
.blob-2 { width:320px; height:320px; background:var(--yellow); bottom:-60px; right:-60px; }
.blob-3 { width:260px; height:260px; background:var(--sky);    bottom:40px;  left:10%; }
.blob-4 { width:200px; height:200px; background:var(--green);  top:20%;      right:8%; }
.blob-5 { width:160px; height:160px; background:var(--lilac);  top:10%;      left:40%; }

/* Petals */
.petal { position:fixed; pointer-events:none; z-index:0; animation:drift linear infinite; opacity:.55; }
@keyframes drift {
  0%   { transform: translateY(-40px) rotate(0deg);   opacity: 0; }
  10%  { opacity: .55; }
  90%  { opacity: .4; }
  100% { transform: translateY(110vh) rotate(360deg); opacity: 0; }
}

/* Gear button */
#gearBtn {
  position: fixed; top: 18px; right: 18px; z-index: 300;
  background: var(--bg2);
  border: 1.5px solid rgba(192,51,77,.2);
  border-radius: 50%; width: 42px; height: 42px;
  display: flex; align-items: center; justify-content: center;
  cursor: pointer;
  box-shadow: 0 2px 10px rgba(192,51,77,.1);
  transition: transform .3s;
}
#gearBtn:hover { transform: rotate(45deg); }
#gearBtn svg { width: 20px; height: 20px; fill: var(--pink); }

/* Settings modal */
#settingsModal {
  display: none; position: fixed; inset: 0; z-index: 400;
  align-items: center; justify-content: center;
  background: rgba(245,239,224,.88);
  backdrop-filter: blur(8px);
}
#settingsModal.show { display: flex; }
.modal-box {
  background: var(--bg2);
  border: 1.5px solid rgba(192,51,77,.2);
  border-radius: 20px;
  padding: 28px 28px 22px;
  box-shadow: 0 8px 32px rgba(192,51,77,.13);
  display: flex; flex-direction: column; gap: 18px;
  min-width: 260px;
}
.modal-box h2 { font-family:'Bebas Neue',sans-serif; letter-spacing:.25em; font-size:1.4rem; color:var(--pink); }
.modal-box label { font-size:.72rem; letter-spacing:.15em; text-transform:uppercase; opacity:.6; }
.modal-box input[type=number] {
  width: 100%; background: var(--bg);
  border: 1.5px solid rgba(192,51,77,.25);
  border-radius: 10px; padding: 10px 14px;
  font-family: 'DM Mono',monospace; font-size: 1.1rem; color: var(--ink);
  margin-top: 6px; outline: none;
}
.modal-box input:focus { border-color: var(--pink); }
.modal-actions { display:flex; gap:10px; justify-content:flex-end; }
.btn-cancel {
  background:none; border:1.5px solid rgba(58,46,30,.2); color:var(--ink);
  border-radius:9px; padding:8px 16px; cursor:pointer;
  font-family:'DM Mono',monospace; font-size:.72rem; letter-spacing:.1em; text-transform:uppercase;
}
.btn-save {
  background:var(--pink); border:none; color:#fff;
  border-radius:9px; padding:8px 18px; cursor:pointer;
  font-family:'DM Mono',monospace; font-size:.72rem; letter-spacing:.1em; text-transform:uppercase;
}

/* Main container */
.container {
  position: relative; z-index: 1;
  display: flex; flex-direction: column; align-items: center;
}

.title {
  font-family: 'Bebas Neue', sans-serif;
  font-size: clamp(1.2rem, 5vw, 1.8rem);
  letter-spacing: .4em; color: var(--ink); opacity: .45;
  margin-bottom: 2rem; text-transform: uppercase;
}

/* Letter display: fixed square, everything centered inside */
.letter-display {
  position: relative;
  width: min(300px, 80vw);
  height: min(300px, 80vw);
  display: flex;
  align-items: center;
  justify-content: center;
}

/* White circle card */
.card {
  position: absolute;
  inset: 18px;
  border-radius: 50%;
  background: var(--bg2);
  box-shadow: 0 8px 32px rgba(180,120,80,.12), 0 2px 8px rgba(180,120,80,.08), inset 0 1px 0 rgba(255,255,255,.8);
  border: 2px solid rgba(255,255,255,.7);
  z-index: 1;
}

/* The single SVG ring â€” sits on top of card, below letter */
.ring-svg {
  position: absolute;
  inset: 0;
  width: 100%;
  height: 100%;
  z-index: 2;
  pointer-events: none;
  /* rotate so arc starts at top */
  transform: rotate(-90deg);
}

/* Idle / spinning: rotate the whole SVG */
.phase-idle .ring-svg,
.phase-spin .ring-svg {
  animation: rotateSvg 18s linear infinite;
}
.phase-spin .ring-svg { animation-duration: 2s; }

@keyframes rotateSvg {
  from { transform: rotate(-90deg); }
  to   { transform: rotate(270deg); }
}

/* During countdown: no rotation */
.phase-countdown .ring-svg,
.phase-done .ring-svg {
  animation: none;
  transform: rotate(-90deg);
}

/* Ring track (always visible, faint dashes) */
#rTrack {
  fill: none;
  stroke: rgba(192,51,77,.15);
  stroke-width: 5;
  stroke-dasharray: 7 9;
  stroke-linecap: round;
}

/* Ring progress arc (solid, shown during countdowns) */
#rArc {
  fill: none;
  stroke: var(--green);
  stroke-width: 5;
  stroke-linecap: round;
  transition: stroke .5s;
}

/* Big letter */
.letter {
  font-family: 'Bebas Neue', sans-serif;
  font-size: min(12rem, 31vw);
  line-height: 1;
  color: var(--ink);
  position: relative;
  z-index: 3;
  transition: color .15s;
}
.letter.flash { animation: flash .08s linear; }
@keyframes flash { 50% { opacity: .2; } }

.phase-countdown .letter,
.phase-done .letter { animation: colorCycle 2s ease-in-out infinite; }
@keyframes colorCycle {
  0%   { color: var(--pink); }
  25%  { color: var(--lilac); }
  50%  { color: var(--green); }
  75%  { color: var(--peach); }
  100% { color: var(--pink); }
}

/* Seconds bubble â€” bottom-right corner of the display box */
#secBubble {
  position: absolute;
  bottom: 0; right: 0;
  background: var(--bg2);
  border: 2px solid var(--pink);
  border-radius: 50px;
  padding: 4px 11px;
  font-family: 'Bebas Neue', sans-serif;
  font-size: 1.1rem;
  color: var(--pink);
  letter-spacing: .05em;
  z-index: 10;
  box-shadow: 0 2px 10px rgba(192,51,77,.18);
  opacity: 0;
  transition: opacity .3s;
  pointer-events: none;
  white-space: nowrap;
}
#secBubble.visible { opacity: 1; }
#secBubble.urgent  { background: var(--pink); color: #fff; }

/* STOPP overlay */
.stopp-overlay {
  position: absolute; inset: 18px; border-radius: 50%;
  background: rgba(245,239,224,.93);
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  z-index: 10; opacity: 0; pointer-events: none; transition: opacity .3s;
}
.stopp-overlay.show { opacity: 1; }
.stopp-overlay span { font-family:'Bebas Neue',sans-serif; font-size:min(4rem,10vw); color:var(--pink); letter-spacing:.15em; }
.stopp-overlay small { font-size:.65rem; letter-spacing:.2em; text-transform:uppercase; color:var(--ink); opacity:.5; margin-top:4px; }

/* Hint & status */
.status {
  margin-top: 1.2rem; font-size: .7rem; letter-spacing: .25em;
  text-transform: uppercase; height: 1em; color: var(--green); opacity: 0; transition: opacity .3s;
}
.phase-countdown .status,
.phase-done .status { opacity: .8; }

.hint {
  margin-top: .8rem; font-size: .7rem; letter-spacing: .2em;
  text-transform: uppercase; color: var(--ink); opacity: .35;
  transition: opacity .4s, color .4s; text-align: center; padding: 0 1rem;
}
.hint.active { opacity: .75; color: var(--pink); }
.hint .key {
  display: inline-block; border: 1.5px solid currentColor;
  padding: 1px 6px 2px; border-radius: 4px; font-size: .65rem; margin-right: 4px;
}

/* Install banners */
#installBanner {
  display: none; position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%);
  background: var(--bg2); border: 1.5px solid rgba(192,51,77,.25); border-radius: 14px;
  padding: 12px 18px; box-shadow: 0 4px 20px rgba(192,51,77,.12);
  z-index: 200; align-items: center; gap: 12px;
  font-size: .72rem; letter-spacing: .08em; color: var(--ink); white-space: nowrap;
}
#installBanner.show { display: flex; }
#installBtn {
  background: var(--pink); color: #fff; border: none; border-radius: 8px;
  padding: 6px 14px; font-family:'DM Mono',monospace; font-size:.7rem;
  letter-spacing:.1em; cursor:pointer; font-weight:500; text-transform:uppercase;
}
#installClose { background:none; border:none; cursor:pointer; color:var(--ink); opacity:.35; font-size:1rem; padding:0 2px; }
#iosBanner {
  display:none; position:fixed; bottom:24px; left:50%; transform:translateX(-50%);
  background:var(--bg2); border:1.5px solid rgba(192,51,77,.2); border-radius:14px;
  padding:14px 18px; box-shadow:0 4px 20px rgba(192,51,77,.1);
  z-index:200; font-size:.7rem; letter-spacing:.07em; color:var(--ink);
  text-align:center; max-width:88vw; line-height:1.7;
}
#iosBanner.show { display: block; }
.close-ios {
  display:inline-block; margin-top:8px; background:none;
  border:1.5px solid var(--pink); color:var(--pink); border-radius:6px;
  padding:4px 12px; cursor:pointer; font-family:'DM Mono',monospace;
  font-size:.68rem; letter-spacing:.1em; text-transform:uppercase;
}
</style>
</head>
<body>

<div class="blob blob-1"></div>
<div class="blob blob-2"></div>
<div class="blob blob-3"></div>
<div class="blob blob-4"></div>
<div class="blob blob-5"></div>

<button id="gearBtn" aria-label="Einstellungen">
  <svg viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.3.06-.61.06-.94s-.02-.64-.07-.94l2.03-1.58a.49.49 0 0 0 .12-.61l-1.92-3.32a.49.49 0 0 0-.59-.22l-2.39.96a7.02 7.02 0 0 0-1.62-.94l-.36-2.54A.48.48 0 0 0 14 2h-4a.48.48 0 0 0-.48.41l-.36 2.54a7.1 7.1 0 0 0-1.61.94l-2.39-.96a.48.48 0 0 0-.59.22L2.65 8.47a.47.47 0 0 0 .12.61l2.03 1.58c-.05.3-.07.63-.07.94s.02.64.07.94l-2.03 1.58a.49.49 0 0 0-.12.61l1.92 3.32c.12.22.37.3.59.22l2.39-.96c.5.36 1.04.67 1.62.94l.36 2.54c.06.28.31.47.59.47h4c.28 0 .53-.19.58-.47l.36-2.54a7.1 7.1 0 0 0 1.61-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32a.47.47 0 0 0-.12-.61l-2.01-1.58zM12 15.6A3.6 3.6 0 0 1 8.4 12 3.6 3.6 0 0 1 12 8.4 3.6 3.6 0 0 1 15.6 12 3.6 3.6 0 0 1 12 15.6z"/></svg>
</button>

<div id="settingsModal">
  <div class="modal-box">
    <h2>Einstellungen</h2>
    <div>
      <label>Rundenzeit (Sekunden)</label>
      <input type="number" id="roundInput" min="5" max="300" value="60">
    </div>
    <div class="modal-actions">
      <button class="btn-cancel" id="modalCancel">Abbrechen</button>
      <button class="btn-save"   id="modalSave">Speichern</button>
    </div>
  </div>
</div>

<div class="container" id="container">
  <div class="title">Stadt Â· Land Â· Fluss</div>

  <div class="letter-display phase-idle" id="display">
    <div class="card"></div>

    <!-- The one SVG ring -->
    <svg class="ring-svg" viewBox="0 0 300 300">
      <circle id="rTrack" cx="150" cy="150" r="144"/>
      <circle id="rArc"   cx="150" cy="150" r="144"/>
    </svg>

    <div class="letter" id="letter">?</div>
    <div id="secBubble">10s</div>

    <div class="stopp-overlay" id="stoppOverlay">
      <span>STOPP</span>
      <small>Runde beendet</small>
    </div>
  </div>

  <div class="status">ğŸŒ¸ Buchstabe gefunden!</div>
  <div class="hint" id="hint"></div>
</div>

<div id="installBanner">
  ğŸŒ¸ Als App installieren
  <button id="installBtn">Installieren</button>
  <button id="installClose">âœ•</button>
</div>
<div id="iosBanner">
  <strong>Zum Homebildschirm hinzufÃ¼gen:</strong><br>
  Tippe auf <strong>Teilen</strong> (â–¡â†‘) und dann auf<br>
  <strong>â€Zum Home-Bildschirm"</strong> ğŸŒ¸<br>
  <button class="close-ios" id="iosClose">Verstanden</button>
</div>

<script>
// â”€â”€ Service Worker â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if ('serviceWorker' in navigator) {
  const sw = `const C='slf-v4';self.addEventListener('install',()=>self.skipWaiting());self.addEventListener('activate',()=>self.clients.claim());self.addEventListener('fetch',e=>e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request))));`;
  navigator.serviceWorker.register(URL.createObjectURL(new Blob([sw],{type:'application/javascript'}))).catch(()=>{});
}

// â”€â”€ Install â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let deferredPrompt = null;
const installBanner = document.getElementById('installBanner');
const iosBanner     = document.getElementById('iosBanner');
const isIOS    = /iphone|ipad|ipod/i.test(navigator.userAgent);
const isMobile = /iphone|ipad|ipod|android/i.test(navigator.userAgent);
if (isIOS && !window.navigator.standalone) setTimeout(()=>iosBanner.classList.add('show'), 1500);
window.addEventListener('beforeinstallprompt', e => { e.preventDefault(); deferredPrompt=e; setTimeout(()=>installBanner.classList.add('show'),1200); });
document.getElementById('installBtn').addEventListener('click', async () => { installBanner.classList.remove('show'); if(deferredPrompt){deferredPrompt.prompt();await deferredPrompt.userChoice;deferredPrompt=null;} });
document.getElementById('installClose').addEventListener('click', ()=>installBanner.classList.remove('show'));
document.getElementById('iosClose').addEventListener('click',     ()=>iosBanner.classList.remove('show'));

// â”€â”€ Settings â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let roundDuration = 60;
const settingsModal = document.getElementById('settingsModal');
const roundInput    = document.getElementById('roundInput');
document.getElementById('gearBtn').addEventListener('click', e => { e.stopPropagation(); roundInput.value = roundDuration; settingsModal.classList.add('show'); });
document.getElementById('modalCancel').addEventListener('click', ()=>settingsModal.classList.remove('show'));
document.getElementById('modalSave').addEventListener('click', () => {
  const v = parseInt(roundInput.value);
  if (v >= 5 && v <= 300) roundDuration = v;
  settingsModal.classList.remove('show');
});
settingsModal.addEventListener('click', e => { if(e.target===settingsModal) settingsModal.classList.remove('show'); });

// â”€â”€ Petals â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const PETALS = ['ğŸŒ¸','ğŸŒ¼','ğŸŒº','ğŸŒ»','ğŸ’','ğŸŒ·'];
for (let i = 0; i < 14; i++) {
  const el = document.createElement('div');
  el.className = 'petal';
  el.textContent = PETALS[i % PETALS.length];
  const dur = 8 + Math.random() * 14;
  el.style.cssText = `left:${Math.random()*100}vw;font-size:${0.9+Math.random()*1.2}rem;animation-duration:${dur}s;animation-delay:-${Math.random()*dur}s`;
  document.body.appendChild(el);
}

// â”€â”€ Audio â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let audioCtx = null;
function getCtx() {
  if (!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();
  if (audioCtx.state === 'suspended') audioCtx.resume();
  return audioCtx;
}
function unlockAudio() {
  const c=getCtx(), b=c.createBuffer(1,1,22050), s=c.createBufferSource();
  s.buffer=b; s.connect(c.destination); s.start(0);
}
function playNotes(notes) {
  try {
    const c = getCtx();
    const play = () => {
      const t = c.currentTime;
      notes.forEach(({f,s,d,v}) => {
        const o=c.createOscillator(), g=c.createGain();
        o.connect(g); g.connect(c.destination);
        o.type='triangle';
        o.frequency.setValueAtTime(f, t+s);
        g.gain.setValueAtTime(0, t+s);
        g.gain.linearRampToValueAtTime(v, t+s+.03);
        g.gain.exponentialRampToValueAtTime(.001, t+s+d+.25);
        o.start(t+s); o.stop(t+s+d+.3);
      });
    };
    // If context is suspended (iOS), resume first then play
    if (c.state === 'suspended') {
      c.resume().then(play);
    } else {
      play();
    }
  } catch(e) {}
}
const beepFound = () => playNotes([{f:523.25,s:0,d:.12,v:.35},{f:659.25,s:.11,d:.12,v:.35},{f:783.99,s:.22,d:.22,v:.4},{f:1046.5,s:.22,d:.22,v:.3},{f:1318.5,s:.22,d:.18,v:.18}]);
const beepEnd   = () => playNotes([{f:392,s:0,d:.15,v:.4},{f:349.23,s:.14,d:.15,v:.4},{f:261.63,s:.28,d:.35,v:.45}]);

// â”€â”€ Ring â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const rArc      = document.getElementById('rArc');
const secBubble = document.getElementById('secBubble');
const CIRC      = 2 * Math.PI * 144; // r=144

// Show the ring as a dashed idle ring (no progress arc)
function ringSetIdle() {
  rArc.style.strokeDasharray  = '7 9';
  rArc.style.strokeDashoffset = '0';
  rArc.style.stroke           = 'rgba(192,51,77,.35)';
}

// Show a solid progress arc. frac = 1 (full) â†’ 0 (empty)
function ringSetProgress(frac) {
  rArc.style.strokeDasharray  = `${CIRC} ${CIRC}`;
  rArc.style.strokeDashoffset = `${CIRC * (1 - frac)}`;
  rArc.style.stroke = frac > .5 ? 'var(--green)' : frac > .2 ? 'var(--yellow)' : 'var(--pink)';
}

ringSetIdle();

// â”€â”€ Generic countdown runner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let cdRaf = null, cdActive = false;
function startCountdown(totalSec, onTick, onDone) {
  cdActive = true;
  const t0 = Date.now();
  function tick() {
    if (!cdActive) return;
    const left = Math.max(0, totalSec - (Date.now()-t0)/1000);
    ringSetProgress(left / totalSec);
    onTick(left);
    if (left <= 0) { cdActive=false; onDone(); return; }
    cdRaf = requestAnimationFrame(tick);
  }
  tick();
}
function stopCountdown() {
  cdActive = false;
  cancelAnimationFrame(cdRaf);
}

// â”€â”€ Phase management â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const display = document.getElementById('display');
function setPhase(p) { display.className = `letter-display phase-${p}`; }

// â”€â”€ Letter scramble â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const LETTERS = 'ABCDEFGHIJKLMNOPRSTUVWZ'.split('');
const letterEl = document.getElementById('letter');
const hint     = document.getElementById('hint');
const stoppOverlay = document.getElementById('stoppOverlay');
let curLetter = '?', letterInt = null, spinHardStop = null, isSpinning = false;

function updateHint(s) {
  const lbl = isMobile
    ? '<span class="key">TAP</span> Antippen zum '
    : '<span class="key">â£</span> Leertaste zum ';
  hint.innerHTML = lbl + (s==='idle'?'Starten' : s==='spin'?'Stoppen' : 'Weiterspielen');
  hint.classList.toggle('active', s==='spin');
}

function startSpin() {
  isSpinning = true;
  setPhase('spin');
  updateHint('spin');
  secBubble.textContent = '10s';
  secBubble.classList.add('visible');
  secBubble.classList.remove('urgent');

  letterInt = setInterval(() => {
    const n = LETTERS[Math.floor(Math.random()*LETTERS.length)];
    if (n !== curLetter) {
      curLetter = n;
      letterEl.textContent = n;
      letterEl.classList.remove('flash');
      void letterEl.offsetWidth;
      letterEl.classList.add('flash');
    }
  }, 80);

  startCountdown(10,
    left => {
      secBubble.textContent = Math.ceil(left) + 's';
      if (left <= 3) secBubble.classList.add('urgent');
    },
    () => { if (isSpinning) stopSpin(); }
  );

  spinHardStop = setTimeout(() => { if (isSpinning) stopSpin(); }, 10500);
}

function stopSpin() {
  isSpinning = false;
  clearInterval(letterInt);
  clearTimeout(spinHardStop);
  stopCountdown();
  setPhase('countdown');
  updateHint('done');
  beepFound();
  secBubble.classList.remove('urgent');
  startRoundCountdown();
}

function startRoundCountdown() {
  startCountdown(roundDuration,
    left => {
      secBubble.textContent = Math.ceil(left) + 's';
      secBubble.classList.add('visible');
      if (left <= 10) secBubble.classList.add('urgent');
    },
    () => {
      beepEnd();
      secBubble.classList.remove('visible','urgent');
      ringSetIdle();
      setPhase('done');
      stoppOverlay.classList.add('show');
      setTimeout(() => { stoppOverlay.classList.remove('show'); setPhase('idle'); updateHint('idle'); }, 2500);
    }
  );
}

function toggle() {
  if (settingsModal.classList.contains('show')) return;
  if (isSpinning) {
    stopSpin();
  } else {
    stopCountdown();
    ringSetIdle();
    secBubble.classList.remove('visible','urgent');
    startSpin();
  }
}

updateHint('idle');

// â”€â”€ Input â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('keydown', e => { if(e.code==='Space'){e.preventDefault();toggle();} });

const tapBtn = document.createElement('button');
Object.assign(tapBtn.style, {
  position:'fixed', inset:'0', width:'100%', height:'100%',
  opacity:'0', cursor:'pointer', zIndex:'50',
  background:'none', border:'none', padding:'0',
  WebkitAppearance:'none', appearance:'none'
});
tapBtn.setAttribute('aria-label','Starten / Stoppen');
tapBtn.addEventListener('click', () => { unlockAudio(); toggle(); });
document.body.appendChild(tapBtn);

// â”€â”€ Shake â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let lastShake=0, lx=null, ly=null, lz=null;
function handleMotion(e) {
  const a = e.accelerationIncludingGravity; if (!a) return;
  const {x,y,z} = a;
  if (lx===null) { lx=x;ly=y;lz=z;return; }
  const d = Math.abs(x-lx)+Math.abs(y-ly)+Math.abs(z-lz);
  lx=x;ly=y;lz=z;
  if (d>18 && Date.now()-lastShake>1000) { lastShake=Date.now(); unlockAudio(); toggle(); }
}
if (typeof DeviceMotionEvent!=='undefined' && typeof DeviceMotionEvent.requestPermission==='function') {
  document.addEventListener('click', async function ask() {
    try { const r=await DeviceMotionEvent.requestPermission(); if(r==='granted') window.addEventListener('devicemotion',handleMotion); }
    catch(e){}
    document.removeEventListener('click',ask);
  }, {once:true});
} else {
  window.addEventListener('devicemotion', handleMotion);
}
</script>
</body>
</html>
